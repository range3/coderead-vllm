<!DOCTYPE HTML>
<html lang="ja" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>データフロー - コードリーディング: vLLM &amp; LMCache</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../../css/general-2459343d.css">
        <link rel="stylesheet" href="../../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/custom-9cb14b51.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex-8bb2998d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc-9f076d22.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">コードリーディング: vLLM &amp; LMCache</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="データフロー"><a class="header" href="#データフロー">データフロー</a></h1>
<blockquote>
<p><strong>深度</strong>: [MEDIUM] / <strong>確信度</strong>: [VERIFIED]
<strong>最終更新</strong>: 2026-02-16（Phase 1 セッション2）</p>
</blockquote>
<p>本ドキュメントはLMCacheのKVキャッシュ store / retrieve パスを追跡する。</p>
<h2 id="store-パス概要"><a class="header" href="#store-パス概要">Store パス概要</a></h2>
<p>vLLMのattentionレイヤー実行中に、KVキャッシュをGPUからCPU（および後段ストレージ）に退避するパス。
<strong>レイヤーワイズ方式</strong>（<code>use_layerwise=True</code>）が主要パスであり、各attentionレイヤーの実行直後にそのレイヤーのKVデータを転送する。</p>
<pre class="mermaid">sequenceDiagram
    participant vLLM as vLLM Attention Layer
    participant Adapter as V1Impl (adapter)
    participant Engine as LMCacheEngine
    participant TDB as TokenDatabase
    participant GPU as GPUConnector
    participant SM as StorageManager
    participant CPU as LocalCPUBackend

    Note over vLLM,Adapter: Layer 0 開始
    vLLM-&gt;&gt;Adapter: save_kv_layer(layer_name, kv_layer, attn_metadata)

    Note over Adapter: layer==0 のとき、各リクエストに対して Generator 生成
    Adapter-&gt;&gt;Engine: store_layer(token_ids, mask, kvcaches, slot_mapping, ...)
    activate Engine
    Engine-&gt;&gt;TDB: process_tokens(tokens, mask)
    TDB--&gt;&gt;Engine: [(start, end, CacheEngineKey), ...]
    Engine-&gt;&gt;SM: batched_allocate(shape, dtype, batch_size=num_layers)
    SM--&gt;&gt;Engine: List[MemoryObj] × num_layers
    Engine-&gt;&gt;GPU: batched_from_gpu(memory_objs, starts, ends, ...)
    Note over GPU: GPU Generator 初期化
    GPU--&gt;&gt;Engine: Generator (primed)
    Note over Engine: yield (Layer 0 の DMA 準備完了)
    deactivate Engine

    Adapter-&gt;&gt;Engine: next(generator) — Layer 0
    activate Engine
    Engine-&gt;&gt;GPU: next(mem_obj_generator)
    Note over GPU: lmc_ops.single_layer_kv_transfer&lt;br/&gt;(paged GPU → buffer → pinned CPU)
    GPU--&gt;&gt;Engine: yield
    Engine-&gt;&gt;SM: batched_put(keys[0], memory_objs[0])
    SM-&gt;&gt;CPU: batched_submit_put_task(keys, objs)
    Note over CPU: hot_cache[key] = memory_obj
    Note over Engine: yield (Layer 0 完了)
    deactivate Engine

    Note over vLLM,Adapter: Layer 1 以降も同じパターン繰り返し
    vLLM-&gt;&gt;Adapter: save_kv_layer(...)
    Adapter-&gt;&gt;Engine: next(generator) — Layer N
    Note over Engine: GPU転送 → StorageManager.batched_put
</pre>

<h2 id="各コンポーネントの役割"><a class="header" href="#各コンポーネントの役割">各コンポーネントの役割</a></h2>
<h3 id="1-lmcacheconnectorv1impladapter"><a class="header" href="#1-lmcacheconnectorv1impladapter">1. LMCacheConnectorV1Impl（adapter）</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/integration/vllm/vllm_v1_adapter.py:964</code> (<code>save_kv_layer</code>)</p>
<p>vLLMの<code>KVConnectorBase_V1.save_kv_layer()</code>フックから呼ばれるアダプタ。
<code>LMCacheConnectorV1Dynamic</code>は純粋な委譲シェルであり、実装は<code>V1Impl</code>に集約。</p>
<p><strong>Layer 0での処理</strong>:</p>
<ol>
<li><code>connector_metadata.requests</code>を走査し、<code>save_spec.can_save</code>がTrueのリクエストを処理</li>
<li><code>skip_leading_tokens</code>をLMCacheのchunk_size（256）の倍数に切り下げてマスク境界を整合</li>
<li><code>store_mask</code>を構築：プレフィックス部分=False、新規部分=True</li>
<li><code>LMCacheEngine.store_layer()</code>を呼んでGeneratorを取得、<code>self.layerwise_storers</code>に追加</li>
<li>最初のリクエストのみ<code>sync=True</code>でCUDAストリームを同期</li>
</ol>
<p><strong>全レイヤー共通</strong>: <code>self.layerwise_storers</code>内の全Generatorを<code>next()</code>で1ステップ進める。</p>
<h3 id="2-lmcacheenginestore_layer"><a class="header" href="#2-lmcacheenginestore_layer">2. LMCacheEngine.store_layer()</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/cache_engine.py:528</code></p>
<p><strong>Generator関数</strong>であり、呼び出し側（adapter）が1レイヤーごとに<code>next()</code>で進める。</p>
<p><strong>初期化フェーズ</strong>（最初のyieldまで）:</p>
<ol>
<li><code>TokenDatabase.process_tokens()</code>でトークン列をチャンク分割し、各チャンクのCacheEngineKeyを取得</li>
<li><code>StorageManager.contains()</code>で既存チャンクをスキップ（layer 0のキーで判定）</li>
<li><code>StorageManager.batched_allocate()</code>で各チャンク×全レイヤー分のMemoryObjを確保</li>
<li>チャンク×レイヤー → レイヤー×チャンクに転置</li>
<li><code>GPUConnector.batched_from_gpu()</code>でGPU転送Generatorを生成・prime</li>
</ol>
<p><strong>レイヤーループ</strong>（<code>num_layers</code>回yield）:</p>
<pre><code>yield → next(mem_obj_generator) → batched_put(keys[layer_id], memory_objs[layer_id])
</code></pre>
<p>各レイヤーで「GPU→CPU DMA」→「ストレージ書き込み」を実行。</p>
<p><strong>重要</strong>: メモリ確保失敗時（<code>batched_allocate</code>がNone）は<code>break</code>で即座にstore中止。yieldだけ行ってストレージには書かない。</p>
<h3 id="3-chunkedtokendatabaseprocess_tokens"><a class="header" href="#3-chunkedtokendatabaseprocess_tokens">3. ChunkedTokenDatabase.process_tokens()</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/token_database.py:309</code></p>
<p>トークン列をチャンク（デフォルト256トークン）に分割し、プレフィックスチェーンハッシュを計算。</p>
<p><strong>ハッシュアルゴリズム</strong>: vLLMと<strong>完全に同一</strong>。</p>
<ul>
<li><code>vllm.utils.hashing.get_hash_fn_by_name("sha256_cbor")</code>を直接利用</li>
<li>NONE_HASHも<code>vllm.v1.core.kv_cache_utils.NONE_HASH</code>から取得</li>
<li>ハッシュ入力: <code>(prefix_hash, token_tuple, extra_keys)</code></li>
</ul>
<p><strong>マスク処理</strong>: <code>mask</code>のFalse数（=already-cached prefix長）がchunk_sizeの倍数であることを検証。False区間のチャンクはスキップ。</p>
<p><strong>CacheEngineKey生成</strong>: <code>_make_key_by_hash()</code>で<code>(model_name, world_size, worker_id, chunk_hash, kv_dtype, request_configs)</code>の6タプルを構築。その後<code>split_layers()</code>でレイヤーIDを付与した<code>LayerCacheEngineKey</code>に分割。</p>
<h3 id="4-vllmpagedmemlayerwisegpuconnectorbatched_from_gpu"><a class="header" href="#4-vllmpagedmemlayerwisegpuconnectorbatched_from_gpu">4. VLLMPagedMemLayerwiseGPUConnector.batched_from_gpu()</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/gpu_connector/gpu_connectors.py:1212</code></p>
<p>GPU上のページドKVキャッシュからCPU上のMemoryObjにデータを転送するGenerator関数。</p>
<p><strong>2段転送パス</strong>（<code>use_gpu=True</code>時）:</p>
<ol>
<li><strong>Paged GPU → 中間GPUバッファ</strong>: <code>lmc_ops.single_layer_kv_transfer()</code>（CUDAカーネル）でslot_mappingに基づきscatter→gatherコピー</li>
<li><strong>GPUバッファ → Pinned CPU</strong>: <code>memory_obj.tensor.copy_(..., non_blocking=True)</code>で非同期DMA</li>
</ol>
<p><strong>直接転送パス</strong>（<code>use_gpu=False</code>時）:</p>
<ul>
<li><code>lmc_ops.single_layer_kv_transfer()</code>でpaged GPUから直接pinned CPUへ（チャンク単位）</li>
</ul>
<p><strong>CUDAストリーム</strong>: <code>self.store_stream</code>（専用ストリーム）を使用し、計算ストリームとオーバーラップ可能。<code>sync=True</code>の場合のみ<code>store_stream.synchronize()</code>で同期。</p>
<p><strong>出力形式</strong>: <code>MemoryFormat.KV_T2D</code> = <code>[num_tokens, 2, hidden_dim]</code>（token-major、K/Vインターリーブ）。MLAの場合は<code>KV_MLA_FMT</code> = <code>[num_tokens, hidden_dim]</code>。</p>
<h3 id="5-storagemanagerbatched_put"><a class="header" href="#5-storagemanagerbatched_put">5. StorageManager.batched_put()</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/storage_backend/storage_manager.py:388</code></p>
<p>登録された全ストレージバックエンドにデータを配布するディスパッチャ。</p>
<p><strong>処理フロー</strong>:</p>
<ol>
<li><code>allocator_backend</code>（通常LocalCPUBackend）の元データをそのまま利用</li>
<li><code>OrderedDict</code>順に全バックエンド（L1→L2→L3）を走査</li>
<li>異なるallocatorを持つバックエンドには<code>allocate_and_copy_objects()</code>で新たにメモリ確保＋コピー</li>
<li>各バックエンドの<code>batched_submit_put_task()</code>を呼び出し</li>
<li>最後にref_countをデクリメント</li>
</ol>
<p><strong>注意</strong>: <code>put()</code>メソッドは<strong>非推奨</strong>（<code>RuntimeError</code>を投げる）。<code>batched_put()</code>が唯一のエントリポイント。</p>
<h3 id="6-localcpubackendsubmit_put_task"><a class="header" href="#6-localcpubackendsubmit_put_task">6. LocalCPUBackend.submit_put_task()</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/storage_backend/local_cpu_backend.py:141</code></p>
<p><strong>同期実行</strong>（バックグラウンドスレッドなし）。<code>cpu_lock</code>下で以下を実行:</p>
<ol>
<li>既存キーの重複チェック</li>
<li><code>memory_obj.ref_count_up()</code>でrefcount増加</li>
<li><code>hot_cache[key] = memory_obj</code>で保存</li>
<li><code>cache_policy.update_on_put(key)</code>でEvictionポリシー更新（LRU: OrderedDictの末尾に移動、等）</li>
<li>必要に応じてcontrollerへADMITメッセージ送信（<code>batched_msg_sender</code>経由）</li>
</ol>
<h2 id="パイプライン動作の詳細"><a class="header" href="#パイプライン動作の詳細">パイプライン動作の詳細</a></h2>
<p>store_layerとbatched_from_gpuは2つの入れ子Generatorで<strong>パイプライン動作</strong>する:</p>
<pre><code>store_layer Generator:     [初期化] → yield → [L0転送+保存] → yield → [L1転送+保存] → yield → ...
batched_from_gpu Generator: [初期化] → yield → [L0 DMA]     → yield → [L1 DMA]     → yield → ...
</code></pre>
<p><strong>タイミング</strong>（<code>num_layers=N</code>の場合）:</p>
<ul>
<li><code>store_layer</code>は<code>N+1</code>回yield（初期化1回 + レイヤーN回）</li>
<li><code>batched_from_gpu</code>は<code>N+1</code>回yield（初期化prime + レイヤーN回）</li>
<li>adapterは合計<code>N</code>回<code>next()</code>を呼ぶ（各attentionレイヤー実行後）</li>
</ul>
<p><strong>パイプラインのステップ</strong>: Layer Lの<code>next()</code>呼び出しで、<code>batched_from_gpu</code>がLayer LのDMAを実行し、<code>store_layer</code>がLayer LのStorageManager書き込みを行う。つまり<strong>DMAとストレージ書き込みは同一レイヤーで連続実行</strong>される。</p>
<h2 id="データ構造"><a class="header" href="#データ構造">データ構造</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>構造</th><th>型</th><th>説明</th></tr>
</thead>
<tbody>
<tr><td>CacheEngineKey</td><td><code>(model_name, world_size, worker_id, chunk_hash, kv_dtype, request_configs)</code></td><td>チャンク単位のキー（レイヤー横断）</td></tr>
<tr><td>LayerCacheEngineKey</td><td>CacheEngineKey + layer_id</td><td>レイヤー単位のキー</td></tr>
<tr><td>MemoryObj</td><td>pinned CPU tensor wrapper</td><td>ref_count管理、MemoryObjMetadata付き</td></tr>
<tr><td>MemoryFormat.KV_T2D</td><td><code>[num_tokens, 2, hidden_dim]</code></td><td>レイヤーワイズ形式（token-major）</td></tr>
<tr><td>MemoryFormat.KV_MLA_FMT</td><td><code>[num_tokens, hidden_dim]</code></td><td>MLA形式（K/V統合）</td></tr>
<tr><td>store_mask</td><td><code>torch.Tensor[bool]</code></td><td>False=キャッシュ済みprefix、True=新規トークン</td></tr>
<tr><td>slot_mapping</td><td><code>torch.Tensor[long]</code></td><td>トークン位置→vLLMページドメモリのflat slot</td></tr>
<tr><td>hot_cache</td><td><code>OrderedDict[CacheEngineKey, MemoryObj]</code></td><td>L1 CPUキャッシュ（Evictionポリシー付き）</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="retrieve-パス概要"><a class="header" href="#retrieve-パス概要">Retrieve パス概要</a></h2>
<p>KVキャッシュをストレージ（CPU/Disk/Remote）からGPUのvLLMページドメモリに復元するパス。
<strong>2フェーズ設計</strong>: Scheduler側の<strong>lookup</strong>（ヒット判定+prefetch指示）と、Worker側の<strong>load</strong>（実際のGPU転送）に分離。</p>
<h3 id="schedulerworker間の情報伝達"><a class="header" href="#schedulerworker間の情報伝達">Scheduler→Worker間の情報伝達</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Sched as V1Impl (Scheduler側)
    participant LC as LookupClient
    participant Worker as V1Impl (Worker側)
    participant Engine as LMCacheEngine

    Note over Sched: vLLM Scheduler.schedule() から呼ばれる
    Sched-&gt;&gt;LC: lookup(token_ids, req_id)
    LC--&gt;&gt;Sched: num_external_hit_tokens
    Note over Sched: LoadSpec(vllm_cached, lmcache_cached) を生成
    Sched-&gt;&gt;Sched: update_state_after_alloc() → can_load=True
    Sched-&gt;&gt;Sched: build_connector_meta() → ReqMeta(load_spec) を構築
    Note over Sched: ConnectorMetadata を SchedulerOutput に添付

    Note over Worker: Forward開始時
    Worker-&gt;&gt;Engine: start_load_kv(forward_context)
    Note over Engine: Bulk or Layerwise retrieve 実行
</pre>

<h3 id="lookupclient-の動作"><a class="header" href="#lookupclient-の動作">LookupClient の動作</a></h3>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/lookup_client/lmcache_lookup_client.py:28</code></p>
<p><code>LMCacheLookupClient</code>はvLLMのSchedulerプロセスで動作する。LMCacheEngine（Worker側）とは<strong>ZMQ IPC</strong>（REQ/REP）で通信。</p>
<p><strong>処理フロー</strong>:</p>
<ol>
<li><code>process_tokens()</code>でトークン列をチャンクハッシュに分割</li>
<li>ハッシュ列をmsgpackシリアライズし、ZMQで<code>LookupServer</code>に送信</li>
<li><code>LookupServer</code>（Worker側）が<code>StorageManager.contains()</code>で存在チェック</li>
<li>ヒットトークン数を返却</li>
</ol>
<p><strong>キャッシュ</strong>: 同一リクエストの2回目以降のlookupは<code>reqs_status</code>辞書から即座に返す。</p>
<h3 id="retrieve-パスの2モード"><a class="header" href="#retrieve-パスの2モード">Retrieve パスの2モード</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>モード</th><th>条件</th><th>エントリポイント</th><th>特徴</th></tr>
</thead>
<tbody>
<tr><td><strong>Bulk</strong></td><td><code>use_layerwise=False</code>（デフォルト）</td><td><code>LMCacheEngine.retrieve()</code></td><td>全レイヤー一括取得→一括GPU転送</td></tr>
<tr><td><strong>Layerwise</strong></td><td><code>use_layerwise=True</code></td><td><code>LMCacheEngine.retrieve_layer()</code></td><td>レイヤー単位Generator、パイプライン可能</td></tr>
</tbody>
</table>
</div>
<h3 id="bulk-retrieve-パス"><a class="header" href="#bulk-retrieve-パス">Bulk Retrieve パス</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Adapter as V1Impl (Worker側)
    participant Engine as LMCacheEngine
    participant TDB as TokenDatabase
    participant SM as StorageManager
    participant CPU as LocalCPUBackend
    participant GPU as GPUConnector (V2)

    Adapter-&gt;&gt;Engine: retrieve(tokens, mask, kvcaches, slot_mapping, ...)
    activate Engine

    Engine-&gt;&gt;TDB: process_tokens(tokens, mask)
    TDB--&gt;&gt;Engine: [(start, end, CacheEngineKey), ...]

    alt async_loading == True
        Note over Engine: event_managerからprefetch済みMemoryObjを取得
        Engine-&gt;&gt;Engine: _async_process_tokens_internal()
    else sync loading
        Engine-&gt;&gt;SM: get_block_mapping(chunk_infos)
        SM--&gt;&gt;Engine: {backend_name: [(key, start, end)]}
        Engine-&gt;&gt;SM: batched_get(keys, location)
        SM-&gt;&gt;CPU: batched_get_blocking(keys)
        CPU--&gt;&gt;SM: List[MemoryObj]（ref_count_up済み）
        SM--&gt;&gt;Engine: List[MemoryObj]
    end

    Engine-&gt;&gt;GPU: batched_to_gpu(memory_objs, starts, ends, slot_mapping=...)
    Note over GPU: load_stream上で全チャンクをGPU転送
    GPU-&gt;&gt;GPU: lmc_ops.multi_layer_kv_transfer(memobj→paged KV)
    GPU--&gt;&gt;Engine: 完了

    Note over Engine: memory_obj.ref_count_down() で解放
    Engine--&gt;&gt;Adapter: ret_mask (bool tensor)
    deactivate Engine
</pre>

<h4 id="_process_tokens_internal-の詳細"><a class="header" href="#_process_tokens_internal-の詳細">_process_tokens_internal() の詳細</a></h4>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/cache_engine.py:1527</code></p>
<ol>
<li><code>process_tokens()</code>でチャンク分割・ハッシュ計算</li>
<li><code>StorageManager.get_block_mapping()</code>でチャンクの<strong>所在バックエンド</strong>を特定
<ul>
<li>各バックエンドの<code>batched_contains()</code>をprefix match方式で呼び出し</li>
<li>チャンクを所在バックエンドごとにグルーピング</li>
</ul>
</li>
<li>バックエンドごとに<code>batched_get()</code>で<code>MemoryObj</code>を取得</li>
<li>取得失敗時は<code>last_failed_block_start</code>以降の<code>ret_mask</code>をFalseに戻し、チャンクリストを切り詰め</li>
</ol>
<h4 id="_async_process_tokens_internal-の詳細"><a class="header" href="#_async_process_tokens_internal-の詳細">_async_process_tokens_internal() の詳細</a></h4>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/cache_engine.py:1463</code></p>
<p>非同期プリフェッチ済みの結果を<code>event_manager</code>から取得するパス。</p>
<ol>
<li><code>event_manager.pop_event(EventType.LOADING, req_id)</code>でprefetch結果の<code>Future</code>を取得</li>
<li><code>future.result()</code>で<code>list[list[tuple[CacheEngineKey, MemoryObj]]]</code>（tier×chunk）を取得</li>
<li><code>process_tokens()</code>で再度チャンク分割し、<code>memory_obj_map</code>からマッチングしてチャンクリストを構築</li>
<li>未使用の<code>MemoryObj</code>は<code>ref_count_down()</code>で即座に解放</li>
</ol>
<h4 id="storagemanagerbatched_get-のwrite-back"><a class="header" href="#storagemanagerbatched_get-のwrite-back">StorageManager.batched_get() のwrite-back</a></h4>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/storage_backend/storage_manager.py:484</code></p>
<p>リモートバックエンド（Disk/Remote）からデータを取得した場合、<strong>自動的にLocalCPUBackendにwrite-back</strong>する。</p>
<ul>
<li><code>LocalCPUBackend</code>以外から取得 &amp;&amp; <code>LocalCPUBackend</code>が存在 &amp;&amp; 全MemoryObjがnon-None → <code>batched_submit_put_task()</code>でL1にコピー</li>
</ul>
<h3 id="layerwise-retrieve-パス"><a class="header" href="#layerwise-retrieve-パス">Layerwise Retrieve パス</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Adapter as V1Impl (Worker側)
    participant Engine as LMCacheEngine
    participant TDB as TokenDatabase
    participant SM as StorageManager
    participant GPU as GPUConnector (Layerwise)

    Note over Adapter: start_load_kv() 内
    Adapter-&gt;&gt;Engine: retrieve_layer(tokens, mask, kvcaches, slot_mapping, sync)
    activate Engine
    Engine-&gt;&gt;TDB: process_tokens(tokens, mask)
    TDB--&gt;&gt;Engine: [(start, end, CacheEngineKey), ...]
    Note over Engine: contains(layer0_key) でヒット判定 + location統一チェック

    Engine-&gt;&gt;SM: layerwise_batched_get(keys_layer_major, location)
    Note over SM: Layer 0 の get_non_blocking を asyncio.create_task() で投入
    Engine-&gt;&gt;GPU: batched_to_gpu(starts, ends, ...) → mem_obj_consumer Generator 生成
    GPU--&gt;&gt;Engine: mem_obj_consumer primed (yield)

    Engine--&gt;&gt;Adapter: yield torch.sum(ret_mask) — Layer 0 のヒット数
    deactivate Engine

    Note over Adapter: next(retriever) で Layer 0 データ受領
    Adapter-&gt;&gt;Engine: next(retriever)
    activate Engine
    Note over Engine: Layer 0 の task.result() を取得
    Engine-&gt;&gt;GPU: mem_obj_consumer.send(mem_objs_layer0)
    Note over GPU: CPU→GPUバッファ copy（load_stream）
    SM--&gt;&gt;Engine: Layer 1 の task yield
    Engine--&gt;&gt;Adapter: yield None
    deactivate Engine

    Note over Adapter: wait_for_layer_load(layer_name) で同期
    Adapter-&gt;&gt;Engine: next(retriever)
    activate Engine
    Note over Engine: Layer N-1 処理...
    Engine--&gt;&gt;Adapter: yield ret_mask（最終レイヤー後）
    deactivate Engine
</pre>

<h4 id="retrieve_layer-の-generator-構造"><a class="header" href="#retrieve_layer-の-generator-構造">retrieve_layer() の Generator 構造</a></h4>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/cache_engine.py:851</code></p>
<p><code>num_layers + 3</code>回yieldする（ヒットあり時）:</p>
<ol>
<li><strong>yield 0</strong>: <code>torch.sum(ret_mask)</code> — ヒットトークン数（sglang統合向け）</li>
<li><strong>yield 1 ~ N-1</strong>: <code>None</code> — 各レイヤーのGPU転送進行中</li>
<li><strong>yield N</strong>: <code>None</code> — 最終レイヤー処理中</li>
<li><strong>yield N+1</strong>: <code>next(mem_obj_consumer)</code> で同期</li>
<li><strong>yield N+2</strong>: <code>ret_mask</code> — 最終結果</li>
</ol>
<p>各レイヤーで:</p>
<ul>
<li><code>next(get_generator)</code>で<code>StorageManager</code>から非同期取得した<code>Future</code>を受け取る</li>
<li><code>task.result()</code>で<code>List[MemoryObj]</code>を取得（ブロッキング）</li>
<li><code>mem_obj_consumer.send(mem_objs_layer)</code>でGPUコネクタにデータを渡す</li>
<li><code>MemoryObj.ref_count_down()</code>は全レイヤー完了後にバッチで実行</li>
</ul>
<h4 id="layerwise-gpuconnectorbatched_to_gpu-のパイプライン"><a class="header" href="#layerwise-gpuconnectorbatched_to_gpu-のパイプライン">Layerwise GPUConnector.batched_to_gpu() のパイプライン</a></h4>
<p><strong>参照</strong>: <code>target/LMCache/lmcache/v1/gpu_connector/gpu_connectors.py:683</code></p>
<p><code>VLLMBufferLayerwiseGPUConnector</code>は<code>num_layers + 2</code>回のイテレーションで<strong>3段パイプライン</strong>を実行:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>イテレーション i</th><th>操作1: paged書き込み</th><th>操作2: RoPE補正+gap zeroing</th><th>操作3: CPU→GPU load</th></tr>
</thead>
<tbody>
<tr><td>i = 0</td><td>—</td><td>—</td><td><code>yield</code>で<code>mem_objs_layer0</code>受領、load_stream上でcopy</td></tr>
<tr><td>i = 1</td><td>—</td><td>Layer 0のRoPE補正</td><td><code>yield</code>で<code>mem_objs_layer1</code>受領、load_stream上でcopy</td></tr>
<tr><td>i = 2</td><td>Layer 0をpagedメモリに書き込み</td><td>Layer 1のRoPE補正</td><td><code>yield</code>で<code>mem_objs_layer2</code>受領</td></tr>
<tr><td>…</td><td>Layer i-2</td><td>Layer i-1</td><td>Layer i</td></tr>
<tr><td>i = N</td><td>Layer N-2</td><td>Layer N-1</td><td><code>yield</code>（同期用、データなし）</td></tr>
<tr><td>i = N+1</td><td>Layer N-1</td><td>—</td><td>—</td></tr>
</tbody>
</table>
</div>
<p><strong>ダブルバッファ</strong>: <code>compute_gpu_buffer_obj</code>と<code>load_gpu_buffer_obj</code>をping-pongして、RoPE計算とDMAをオーバーラップ。</p>
<p><strong>RoPE位置補正</strong>: <code>cache_positions=True</code>の場合、保存時の位置と現在の位置の差分で<code>fused_rotary_emb()</code>を適用。保存時位置は<code>MemoryObjMetadata.cached_positions</code>から取得。</p>
<p><strong>gap zeroing</strong>: チャンク間のギャップ位置（連続しないstart/endの隙間）をゼロ埋め。</p>
<h3 id="非同期プリフェッチの全体フロー"><a class="header" href="#非同期プリフェッチの全体フロー">非同期プリフェッチの全体フロー</a></h3>
<pre class="mermaid">sequenceDiagram
    participant Sched as V1Impl (Scheduler)
    participant LC as LookupClient
    participant LS as LookupServer (Worker)
    participant SM as StorageManager
    participant EM as EventManager
    participant Worker as V1Impl (Worker)
    participant Engine as LMCacheEngine

    Note over Sched: get_num_new_matched_tokens() 内
    Sched-&gt;&gt;LC: lookup(token_ids, req_id)
    LC-&gt;&gt;LS: ZMQ REQ (hashes + offsets + req_id)
    LS-&gt;&gt;SM: async_lookup_and_prefetch(lookup_id, keys, ...)
    Note over SM: 各バックエンドに batched_async_contains → batched_get_non_blocking
    SM-&gt;&gt;EM: add_event(LOADING, lookup_id, all_done_task)
    LS--&gt;&gt;LC: num_hit_tokens
    LC--&gt;&gt;Sched: num_external_hit_tokens

    Note over Sched: build_connector_meta() で LoadSpec を ConnectorMetadata に格納

    Note over Worker: start_load_kv() 内
    Worker-&gt;&gt;Engine: retrieve(tokens, mask, ..., req_id=req_id)
    Engine-&gt;&gt;EM: pop_event(LOADING, req_id)
    Note over Engine: future.result() で prefetch 済み MemoryObj を取得
    Engine-&gt;&gt;Engine: _async_process_tokens_internal()
    Engine-&gt;&gt;GPU: batched_to_gpu(memory_objs, ...)
</pre>

<p><strong>ポイント</strong>:</p>
<ul>
<li>Scheduler側のlookupがprefetchを<strong>トリガー</strong>し、Worker側のretrieveがprefetch結果を<strong>消費</strong>する</li>
<li><code>EventManager</code>が両者を<code>lookup_id</code>（=req_id）で紐付け</li>
<li>prefetchは<code>asyncio.create_task()</code>で非同期実行され、Worker側のretrieveまでに完了していればブロッキングなし</li>
</ul>
<h3 id="token_mask-と-ret_mask-の意味"><a class="header" href="#token_mask-と-ret_mask-の意味">token_mask と ret_mask の意味</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>マスク</th><th>用途</th><th>値の意味</th></tr>
</thead>
<tbody>
<tr><td><code>token_mask</code></td><td>adapter側で構築</td><td><code>False</code>=vLLMがキャッシュ済み（チャンク境界まで切り詰め）、<code>True</code>=LMCacheから要ロード</td></tr>
<tr><td><code>ret_mask</code></td><td>Engine内部で構築</td><td><code>True</code>=実際にLMCacheから取得成功、<code>False</code>=未取得</td></tr>
<tr><td><code>mask</code>（Engine引数）</td><td>token_maskと同じ</td><td><code>process_tokens()</code>のFalseプレフィックス=スキップ対象</td></tr>
</tbody>
</table>
</div>
<p><code>token_mask</code>のFalse区間は<code>vllm_cached_tokens</code>をchunk_sizeの倍数に切り下げた範囲。これにより、vLLMとLMCacheのキャッシュ境界がチャンク単位で整合する（オーバーラップ領域はLMCacheが上書き）。</p>
<h3 id="エラーハンドリング"><a class="header" href="#エラーハンドリング">エラーハンドリング</a></h3>
<ul>
<li><strong>部分的取得失敗</strong>: <code>ret_mask.sum() &lt; expected</code>の場合、<code>record_failed_blocks()</code>で失敗ブロックIDを計算し、<code>_invalid_block_ids</code>に蓄積。vLLMのSchedulerが次stepで<code>get_block_ids_with_load_errors()</code>で回収し、再計算を指示</li>
<li><strong>StorageManager.batched_get()</strong>: <code>memory_obj=None</code>が返された場合、<code>last_failed_block_start</code>以降を切り捨て（prefix matchの性質上、途中の欠損以降は全て無効）</li>
<li><strong>健全性チェック</strong>: <code>is_healthy()==False</code>の場合、retrieve自体をスキップ（ゼロマスクを返す）</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../lmcache/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../../lmcache/architecture/overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../lmcache/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../../lmcache/architecture/overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../../mark-09e88c2c.min.js"></script>
        <script src="../../searcher-c2a407aa.js"></script>

        <script src="../../clipboard-1626706a.min.js"></script>
        <script src="../../highlight-abc7f01d.js"></script>
        <script src="../../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid-eefea253.min.js"></script>
        <script src="../../mermaid-init-ccf746f1.js"></script>



    </div>
    </body>
</html>
