<!DOCTYPE HTML>
<html lang="ja" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Gemma3 27B ビジョンパイプライン: 形状フローと数値まとめ - コードリーディング: vLLM</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/custom-9cb14b51.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-e702de5d.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-bf1dd1a9.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">コードリーディング: vLLM</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="gemma3-27b-ビジョンパイプライン-形状フローと数値まとめ"><a class="header" href="#gemma3-27b-ビジョンパイプライン-形状フローと数値まとめ">Gemma3 27B ビジョンパイプライン: 形状フローと数値まとめ</a></h1>
<h2 id="モデルパラメータconfigjson--preprocessor_configjson"><a class="header" href="#モデルパラメータconfigjson--preprocessor_configjson">モデルパラメータ（config.json + preprocessor_config.json）</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>パラメータ</th><th>値</th><th>出典</th></tr>
</thead>
<tbody>
<tr><td>image_size</td><td>896</td><td>vision_config</td></tr>
<tr><td>patch_size</td><td>14</td><td>vision_config</td></tr>
<tr><td>vision hidden_size</td><td>1152</td><td>vision_config</td></tr>
<tr><td>vision num_heads</td><td>16</td><td>vision_config</td></tr>
<tr><td>vision num_layers</td><td>27</td><td>vision_config</td></tr>
<tr><td>text hidden_size</td><td>5376</td><td>text_config</td></tr>
<tr><td>text num_heads</td><td>32</td><td>text_config</td></tr>
<tr><td>text num_layers</td><td>62</td><td>text_config</td></tr>
<tr><td>mm_tokens_per_image</td><td>256</td><td>config.json</td></tr>
<tr><td>image_token_index</td><td>262144</td><td>config.json</td></tr>
<tr><td>boi_token_index</td><td>255999</td><td>config.json</td></tr>
<tr><td>eoi_token_index</td><td>256000</td><td>config.json</td></tr>
</tbody>
</table>
</div>
<h3 id="導出値"><a class="header" href="#導出値">導出値</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>導出パラメータ</th><th>計算</th><th>値</th></tr>
</thead>
<tbody>
<tr><td>patches_per_image</td><td>896 / 14</td><td><strong>64</strong></td></tr>
<tr><td>エンコーダ入力パッチ数</td><td>64²</td><td><strong>4096</strong></td></tr>
<tr><td>tokens_per_side</td><td>√256</td><td><strong>16</strong></td></tr>
<tr><td>AvgPool2d kernel_size</td><td>64 / 16</td><td><strong>4</strong></td></tr>
<tr><td>Projector 出力トークン/画像</td><td>16²</td><td><strong>256</strong> (= mm_tokens_per_image ✅)</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="pan-and-scan-設定"><a class="header" href="#pan-and-scan-設定">Pan-and-Scan 設定</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>パラメータ</th><th>preprocessor_config.json</th><th>フォールバックデフォルト</th><th>出典</th></tr>
</thead>
<tbody>
<tr><td>do_pan_and_scan</td><td>null</td><td><strong>False</strong></td><td>processing_gemma3.py L44</td></tr>
<tr><td>pan_and_scan_min_crop_size</td><td>null</td><td><strong>256</strong></td><td>processing_gemma3.py L45</td></tr>
<tr><td>pan_and_scan_max_num_crops</td><td>null</td><td><strong>4</strong></td><td>processing_gemma3.py L46</td></tr>
<tr><td>pan_and_scan_min_ratio_to_activate</td><td>null</td><td><strong>1.2</strong></td><td>processing_gemma3.py L47</td></tr>
</tbody>
</table>
</div>
<ul>
<li>Google はモデル配布時にこれらを<strong>すべて null</strong> にしている</li>
<li>デフォルト値は HF transformers の <code>Gemma3ProcessorKwargs._defaults</code> で定義</li>
<li><strong>デフォルトでは Pan-and-Scan は無効</strong></li>
<li>有効化: vLLM では <code>--hf-overrides '{"do_pan_and_scan": true}'</code></li>
</ul>
<hr>
<h2 id="api-リクエストからデコーダ入力までの全体フロー"><a class="header" href="#api-リクエストからデコーダ入力までの全体フロー">API リクエストからデコーダ入力までの全体フロー</a></h2>
<h3 id="step-1-ユーザーの-api-リクエスト"><a class="header" href="#step-1-ユーザーの-api-リクエスト">Step 1: ユーザーの API リクエスト</a></h3>
<pre><code class="language-json">{
  "model": "gemma-3-27b-it",
  "messages": [
    {
      "role": "user",
      "content": [
        {"type": "image_url", "image_url": {"url": "data:image/png;base64,..."}},
        {"type": "text", "text": "この文書を要約して"}
      ]
    }
  ]
}
</code></pre>
<p>ユーザーは画像を1枚渡すだけ。クロップの存在を意識する必要はない。</p>
<h3 id="step-2-chat_template-適用"><a class="header" href="#step-2-chat_template-適用">Step 2: chat_template 適用</a></h3>
<p>vLLM が chat_template を適用してプロンプト文字列を生成:</p>
<pre><code>&lt;start_of_turn&gt;user
&lt;start_of_image&gt;この文書を要約して&lt;end_of_turn&gt;
&lt;start_of_turn&gt;model
</code></pre>
<p><code>&lt;start_of_image&gt;</code> は <code>boi_token</code> (token_id=255999)。この時点ではプレースホルダが <strong>1個だけ</strong>。</p>
<h3 id="step-3-gemma3processorcall--cpu-側前処理"><a class="header" href="#step-3-gemma3processorcall--cpu-側前処理">Step 3: Gemma3Processor.<strong>call</strong>() — CPU 側前処理</a></h3>
<h4 id="3a-image_processor-による画像前処理"><a class="header" href="#3a-image_processor-による画像前処理">3a: image_processor による画像前処理</a></h4>
<pre><code class="language-python">image_inputs = self.image_processor(images, **output_kwargs["images_kwargs"])
</code></pre>
<p>画像をリサイズ・正規化し、Pan-and-Scan が有効ならクロップも生成する。</p>
<h4 id="3b-num_crops-の取得"><a class="header" href="#3b-num_crops-の取得">3b: num_crops の取得</a></h4>
<pre><code class="language-python">num_crops = to_py_obj(image_inputs.pop("num_crops"))
</code></pre>
<h4 id="3c-プロンプトの自動書き換えpan-and-scan-時のみ"><a class="header" href="#3c-プロンプトの自動書き換えpan-and-scan-時のみ">3c: プロンプトの自動書き換え（Pan-and-Scan 時のみ）</a></h4>
<pre><code class="language-python">for num, idx in reversed(list(zip(num_crops, image_indexes))):
    if num:  # num=0 なら falsy → この書き換えは発生しない
        formatted_image_text = (
            f"Here is the original image {self.boi_token} "
            f"and here are some crops to help you see better "
            + " ".join([self.boi_token] * num)
        )
        prompt = prompt[:idx] + formatted_image_text + prompt[idx + len(self.boi_token):]
</code></pre>
<p><strong>Pan-and-Scan 無効（num=0）時</strong>: <code>if num:</code> が falsy なので、書き換えは<strong>一切発生しない</strong>。
<code>&lt;start_of_image&gt;</code> は1個のまま次のステップへ。</p>
<p><strong>Pan-and-Scan 有効（num=2）時</strong>: 1個の <code>&lt;start_of_image&gt;</code> が以下に置き換えられる:</p>
<pre><code>Here is the original image &lt;start_of_image&gt; and here are some crops to help you see better &lt;start_of_image&gt; &lt;start_of_image&gt;
</code></pre>
<h4 id="3d-boi_token--full_image_sequence-への展開"><a class="header" href="#3d-boi_token--full_image_sequence-への展開">3d: boi_token → full_image_sequence への展開</a></h4>
<pre><code class="language-python">self.full_image_sequence = f"\n\n{boi_token}{image_token * 256}{eoi_token}\n\n"
# = "\n\n&lt;start_of_image&gt;&lt;image&gt;×256&lt;end_of_image&gt;\n\n"

text = [prompt.replace(self.boi_token, self.full_image_sequence) for prompt in text]
</code></pre>
<p>全ての <code>&lt;start_of_image&gt;</code> がそれぞれ 256個の <code>&lt;image&gt;</code> トークンを含む <code>full_image_sequence</code> に展開される。</p>
<h4 id="3e-tokenizer-で-token_ids-に変換"><a class="header" href="#3e-tokenizer-で-token_ids-に変換">3e: tokenizer で token_ids に変換</a></h4>
<pre><code class="language-python">text_inputs = self.tokenizer(text=text, **output_kwargs["text_kwargs"])
</code></pre>
<p><code>&lt;image&gt;</code> トークン (token_id=262144) が並んだ input_ids が生成される。</p>
<h4 id="3f-token_type_ids-の生成"><a class="header" href="#3f-token_type_ids-の生成">3f: token_type_ids の生成</a></h4>
<pre><code class="language-python">mm_token_type_ids[array_ids == self.image_token_id] = 1
# → &lt;image&gt; トークン位置が 1、それ以外が 0
</code></pre>
<hr>
<h2 id="ケース1-デフォルトpan-and-scan-無効"><a class="header" href="#ケース1-デフォルトpan-and-scan-無効">ケース1: デフォルト（Pan-and-Scan 無効）</a></h2>
<p>入力例: A4 150dpi 画像 (1240 × 1754 pixel)</p>
<h3 id="プロンプト変換の流れ"><a class="header" href="#プロンプト変換の流れ">プロンプト変換の流れ</a></h3>
<pre><code>ユーザー入力:
  画像1枚 + "この文書を要約して"

chat_template 適用後:
  "...&lt;start_of_image&gt;この文書を要約して..."
                ↑
          boi_token 1個

do_pan_and_scan=False → num_crops=0 → プロンプト書き換えなし

boi_token → full_image_sequence 展開後:
  "...\n\n&lt;start_of_image&gt;&lt;image&gt;×256&lt;end_of_image&gt;\n\nこの文書を要約して..."
           ↑              ↑×256  ↑
         255999         262144  256000

tokenize 後の input_ids (概念的):
  [..., 255999, 262144, 262144, ...(×256)..., 262144, 256000, ..., テキスト, ...]
</code></pre>
<h3 id="cpu-側前処理"><a class="header" href="#cpu-側前処理">CPU 側前処理</a></h3>
<pre><code>元画像 (1240×1754)
    │  resize(896×896, bilinear)   ← アスペクト比無視の正方形リサイズ
    │  rescale(× 1/255)            ← [0,255] → [0,1]
    │  normalize(mean=0.5, std=0.5) ← [0,1] → [-1,1]
    ▼
pixel_values: (1, 3, 896, 896)
num_patches:  tensor([1])
</code></pre>
<h3 id="gpu-側-siglipvisionmodel"><a class="header" href="#gpu-側-siglipvisionmodel">GPU 側: SiglipVisionModel</a></h3>
<pre><code>(1, 3, 896, 896)
    │  Conv2d(3 → 1152, kernel=14, stride=14)
    ▼
(1, 1152, 64, 64)              ← 896/14 = 64
    │  flatten + transpose
    ▼
(1, 4096, 1152)                ← 64² = 4096 パッチ
    │  + position_embedding(4096, 1152)
    ▼
(1, 4096, 1152)
    │  SiglipEncoder × 27層
    │  （双方向 Attention, heads=16, 4096トークン間全対全）
    ▼
(1, 4096, 1152)
    │  post_layernorm
    ▼
(1, 4096, 1152)
</code></pre>
<h3 id="gpu-側-gemma3multimodalprojector"><a class="header" href="#gpu-側-gemma3multimodalprojector">GPU 側: Gemma3MultiModalProjector</a></h3>
<pre><code>(1, 4096, 1152)
    │  transpose → (1, 1152, 4096)
    │  reshape  → (1, 1152, 64, 64)     ← 2Dグリッドに復元
    │
    │  AvgPool2d(kernel_size=4, stride=4)
    ▼
(1, 1152, 16, 16)                       ← 64/4 = 16
    │  flatten(2) → (1, 1152, 256)
    │  transpose  → (1, 256, 1152)       ← 16² = 256 トークン
    │
    │  GemmaRMSNorm(1152)
    ▼
(1, 256, 1152)
    │
    │  matmul(mm_input_projection_weight)  ← shape: (1152, 5376)
    ▼
(1, 256, 5376)                           ← text hidden_size 空間
</code></pre>
<h3 id="gpu-側-split--flatten"><a class="header" href="#gpu-側-split--flatten">GPU 側: split + flatten</a></h3>
<pre><code>(1, 256, 5376)
    │  split by num_patches=[1] → [(1, 256, 5376)]
    │  flatten(0, 1)
    ▼
(256, 5376)                              ← 最終出力
</code></pre>
<h3 id="gpu-側-テキスト埋め込みとマージ"><a class="header" href="#gpu-側-テキスト埋め込みとマージ">GPU 側: テキスト埋め込みとマージ</a></h3>
<pre><code class="language-python">text_embeds = embed_tokens(input_ids) * normalizer   # (seq_len, 5376)
# token_id=262144 は vocab 外 → handle_oov_mm_token=True でゼロ埋め
# is_multimodal: (seq_len,) ← 256箇所が True

merged = masked_scatter_(text_embeds, is_multimodal, mm_embeds)  # (256, 5376)
# → 262144 だった256箇所をビジョン埋め込みで上書き
# ※ ビジョン埋め込みには normalizer スケーリングは適用されない

→ (seq_len, 5376) として Gemma3 Decoder (62層) へ
</code></pre>
<h3 id="消費トークン数-256"><a class="header" href="#消費トークン数-256">消費トークン数: <strong>256</strong></a></h3>
<hr>
<h2 id="ケース2-pan-and-scan-有効"><a class="header" href="#ケース2-pan-and-scan-有効">ケース2: Pan-and-Scan 有効</a></h2>
<p>入力例: 同じ A4 150dpi 画像 (1240 × 1754 pixel)</p>
<h3 id="プロンプト変換の流れ-1"><a class="header" href="#プロンプト変換の流れ-1">プロンプト変換の流れ</a></h3>
<pre><code>ユーザー入力:
  画像1枚 + "この文書を要約して"

chat_template 適用後:
  "...&lt;start_of_image&gt;この文書を要約して..."
                ↑
          boi_token 1個

do_pan_and_scan=True → ratio=1754/1240≈1.415 &gt; 1.2 → num_crops=2

Processor がプロンプトを自動書き換え (Step 3c):
  "...Here is the original image &lt;start_of_image&gt; and here are
   some crops to help you see better &lt;start_of_image&gt; &lt;start_of_image&gt;
   この文書を要約して..."
                                      ↑               ↑              ↑
                                 original 用       crop 0 用      crop 1 用

boi_token → full_image_sequence 展開後:
  "...Here is the original image \n\n&lt;boi&gt;&lt;image&gt;×256&lt;eoi&gt;\n\n and here are
   some crops to help you see better \n\n&lt;boi&gt;&lt;image&gt;×256&lt;eoi&gt;\n\n
   \n\n&lt;boi&gt;&lt;image&gt;×256&lt;eoi&gt;\n\nこの文書を要約して..."

tokenize 後:
  [..., "Here", "is", ...,
   255999, 262144×256, 256000,          ← original
   ..., "and", "here", ...,
   255999, 262144×256, 256000,          ← crop 0
   ...,
   255999, 262144×256, 256000,          ← crop 1
   ..., テキスト, ...]
</code></pre>
<h3 id="cpu-側-pan-and-scan-判定"><a class="header" href="#cpu-側-pan-and-scan-判定">CPU 側: Pan-and-Scan 判定</a></h3>
<pre><code class="language-python"># 縦長画像 (height &gt; width)
ratio = 1754 / 1240 ≈ 1.415
min_ratio_to_activate = 1.2
1.415 &gt; 1.2 → ✅ 発動
</code></pre>
<h3 id="cpu-側-クロップ数計算"><a class="header" href="#cpu-側-クロップ数計算">CPU 側: クロップ数計算</a></h3>
<pre><code class="language-python"># 縦長パス (image_height &gt; image_width)
num_crops_h = min(
    floor(1754 / 256),          # = 6  ← min_crop_size 制約
    floor(1754 / 1240 + 0.5),   # = 1  ← アスペクト比近似
)
# → min(6, 1) = 1
num_crops_h = max(2, 1) = 2    # 最低2クロップに強制
num_crops_h = min(4, 2) = 2    # max_num_crops でクリップ
num_crops_w = 1

# クロップサイズ検証
crop_size_w = ceil(1240 / 1) = 1240
crop_size_h = ceil(1754 / 2) = 877
min(1240, 877) = 877 &gt; 256 (min_crop_size) → ✅ 有効

結果: 1 × 2 = 2 クロップ
</code></pre>
<h3 id="cpu-側-クロップ切り出し--リサイズ"><a class="header" href="#cpu-側-クロップ切り出し--リサイズ">CPU 側: クロップ切り出し + リサイズ</a></h3>
<pre><code>元画像 (1240×1754)
  ├── original  (1240×1754) → resize(896×896) → normalize → (3, 896, 896)
  ├── crop 0    (1240×877)  → resize(896×896) → normalize → (3, 896, 896)
  └── crop 1    (1240×877)  → resize(896×896) → normalize → (3, 896, 896)
                                                              │ stack
                                                pixel_values: (3, 3, 896, 896)
                                                num_patches:  tensor([3])
</code></pre>
<h3 id="gpu-側-siglipvisionmodel-1"><a class="header" href="#gpu-側-siglipvisionmodel-1">GPU 側: SiglipVisionModel</a></h3>
<pre><code>(3, 3, 896, 896)
    │  Conv2d(3 → 1152, kernel=14, stride=14)
    ▼
(3, 1152, 64, 64)
    │  flatten + transpose
    ▼
(3, 4096, 1152)                 ← 3枚 × 4096パッチ
    │  + position_embedding
    ▼
(3, 4096, 1152)
    │  SiglipEncoder × 27層（双方向 Attention）
    ▼
(3, 4096, 1152)
</code></pre>
<h3 id="gpu-側-gemma3multimodalprojector-1"><a class="header" href="#gpu-側-gemma3multimodalprojector-1">GPU 側: Gemma3MultiModalProjector</a></h3>
<pre><code>(3, 4096, 1152)
    │  → reshape → (3, 1152, 64, 64)
    │  AvgPool2d(k=4, s=4)
    ▼
(3, 1152, 16, 16)
    │  flatten + transpose
    ▼
(3, 256, 1152)
    │  RMSNorm → matmul(1152 → 5376)
    ▼
(3, 256, 5376)
</code></pre>
<h3 id="gpu-側-split--flatten-1"><a class="header" href="#gpu-側-split--flatten-1">GPU 側: split + flatten</a></h3>
<pre><code>(3, 256, 5376)
    │  split by num_patches=[3] → [(3, 256, 5376)]
    │  flatten(0, 1)
    ▼
(768, 5376)                     ← 3 × 256 = 768 トークン
</code></pre>
<h3 id="gpu-側-テキスト埋め込みとマージ-1"><a class="header" href="#gpu-側-テキスト埋め込みとマージ-1">GPU 側: テキスト埋め込みとマージ</a></h3>
<pre><code>input_ids 中の token_id=262144 が768箇所
↓ masked_scatter_ で (768, 5376) を順番に書き込み
→ (seq_len, 5376) として Gemma3 Decoder へ
</code></pre>
<h3 id="消費トークン数-768--256--3"><a class="header" href="#消費トークン数-768--256--3">消費トークン数: <strong>768</strong> (= 256 × 3)</a></h3>
<hr>
<h2 id="プロンプト比較"><a class="header" href="#プロンプト比較">プロンプト比較</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th></th><th>Pan-and-Scan 無効（デフォルト）</th><th>Pan-and-Scan 有効</th></tr>
</thead>
<tbody>
<tr><td>プロンプト書き換え</td><td>なし</td><td>“Here is the original image … crops …” 挿入</td></tr>
<tr><td>boi_token 数</td><td>1</td><td>1 + num_crops (= 3)</td></tr>
<tr><td><code>&lt;image&gt;</code> トークン数</td><td>256</td><td>256 × (1 + num_crops) = 768</td></tr>
<tr><td>装飾テキスト</td><td>なし</td><td>“Here is the original image”, “and here are some crops to help you see better”</td></tr>
<tr><td>pixel_values shape</td><td>(1, 3, 896, 896)</td><td>(3, 3, 896, 896)</td></tr>
<tr><td>num_patches</td><td>tensor([1])</td><td>tensor([3])</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="全体データフロー図"><a class="header" href="#全体データフロー図">全体データフロー図</a></h2>
<pre><code>                        ┌─────────────────────────────┐
                        │  OpenAI 互換 API リクエスト    │
                        │  画像1枚 + テキスト           │
                        └────────────┬────────────────┘
                                     │
                        ┌────────────┴────────────────┐
                        │  chat_template 適用           │
                        │  → "&lt;start_of_image&gt;テキスト"  │
                        │    boi_token(255999) が1個    │
                        └────────────┬────────────────┘
                                     │
                        ┌────────────┴────────────────┐
                        │  CPU: Gemma3Processor        │
                        │                              │
                        │  image_processor:             │
                        │    resize(896×896)            │
                        │    rescale(×1/255)            │
                        │    normalize(0.5, 0.5)        │
                        │    Pan-and-Scan 時はクロップ生成│
                        │                              │
                        │  do_pan_and_scan?             │
                        │  ├── False:                   │
                        │  │   書き換えなし              │
                        │  │   boi_token 1個のまま       │
                        │  │   pixel_values: (1,3,896,896)│
                        │  │                            │
                        │  └── True &amp; ratio &gt; 1.2:      │
                        │      "Here is the original    │
                        │       image &lt;boi&gt; and here    │
                        │       are some crops ...      │
                        │       &lt;boi&gt; &lt;boi&gt;"            │
                        │      boi_token 3個に増加       │
                        │      pixel_values: (3,3,896,896)│
                        │                              │
                        │  各 boi_token を展開:          │
                        │  "\n\n&lt;boi&gt;&lt;img&gt;×256&lt;eoi&gt;\n\n" │
                        │                              │
                        │  tokenizer → input_ids        │
                        │  token_type_ids 生成           │
                        └────────────┬────────────────┘
                                     │
                        input_ids:     [..., 262144×256, ...(×N)...]
                        pixel_values:  (total_patches, 3, 896, 896)
                        num_patches:   (num_images,)
                                     │
                        ═════════════╪═══════════════ CPU → GPU
                                     │
                        ┌────────────┴────────────────┐
                        │  GPU: SiglipVisionEmbeddings │
                        │  Conv2d(3→1152, k=14, s=14)  │
                        │  + position_embedding         │
                        └────────────┬────────────────┘
                                     │
                        (total_patches, 4096, 1152)
                                     │
                        ┌────────────┴────────────────┐
                        │  GPU: SiglipEncoder           │
                        │  27層 双方向 Transformer       │
                        │  heads=16, hidden=1152        │
                        └────────────┬────────────────┘
                                     │
                        (total_patches, 4096, 1152)
                                     │
                        ┌────────────┴────────────────┐
                        │  GPU: Gemma3MultiModalProjector│
                        │  reshape → (*, 1152, 64, 64) │
                        │  AvgPool2d(k=4, s=4)          │
                        │  → (*, 1152, 16, 16)          │
                        │  flatten + transpose           │
                        │  → (*, 256, 1152)             │
                        │  GemmaRMSNorm(1152)            │
                        │  matmul(1152 → 5376)           │
                        └────────────┬────────────────┘
                                     │
                        (total_patches, 256, 5376)
                                     │
                        ┌────────────┴────────────────┐
                        │  split by num_patches         │
                        │  flatten(0, 1) per image      │
                        │  → list[(N×256, 5376)]        │
                        └────────────┬────────────────┘
                                     │
                        ┌────────────┴────────────────┐
                        │  GPU: embed_input_ids()       │
                        │                              │
                        │  text = embed_tokens(ids)     │
                        │         × normalizer          │
                        │  ※ 262144 は vocab 外         │
                        │    → handle_oov_mm_token=True │
                        │    → ゼロ埋め                  │
                        │                              │
                        │  masked_scatter_(             │
                        │    text, is_multimodal,       │
                        │    mm_embeds)                 │
                        │                              │
                        │  ※ vision embeds には          │
                        │    normalizer 未適用            │
                        └────────────┬────────────────┘
                                     │
                        (seq_len, 5376)
                                     │
                        ┌────────────┴────────────────┐
                        │  GPU: Gemma3 Decoder          │
                        │  62層, heads=32, kv_heads=16  │
                        │  sliding_window=1024          │
                        │  head_dim=128                 │
                        └──────────────────────────────┘
</code></pre>
<hr>
<h2 id="注意事項"><a class="header" href="#注意事項">注意事項</a></h2>
<ol>
<li>
<p><strong>ビジョン埋め込みの正規化</strong>: テキスト埋め込みには <code>embed_tokens(ids) × normalizer</code> のスケーリングが適用されるが、ビジョン埋め込みには <code>mm_soft_emb_norm</code>（RMSNorm）のみが適用され、<code>normalizer</code> スケーリングは適用されない。</p>
</li>
<li>
<p><strong>V1 での制限</strong>: Pan-and-Scan 有効時、V1 エンジンでは画像トークン間の双方向アテンションが簡略化されたパターンで実装されており、元モデルのアテンションパターンと完全には一致しない。</p>
</li>
<li>
<p><strong>AvgPool2d の役割</strong>: エンコーダは 4096 パッチ（64×64 グリッド）の高解像度で処理しつつ、AvgPool2d(k=4, s=4) で 256 トークン（16×16）に圧縮して LLM に渡す。これにより計算量と情報量のバランスを取っている。</p>
</li>
<li>
<p><strong>Pan-and-Scan のプロンプト</strong>: クロップありの場合のみ、Processor が “Here is the original image … and here are some crops to help you see better …” という装飾テキストを自動挿入する。クロップなしの場合この装飾テキストは存在せず、<code>&lt;image&gt;</code> トークン列のみとなる。ユーザーはクロップの存在を意識する必要はない。</p>
</li>
<li>
<p><strong>token_id=262144 の扱い</strong>: <code>&lt;image&gt;</code> トークンの token_id=262144 は通常の vocab 範囲外（OOV）。<code>handle_oov_mm_token=True</code> により安全にゼロ埋めされ、後続の <code>masked_scatter_</code> でビジョン埋め込みに上書きされる。</p>
</li>
<li>
<p><strong>Pan-and-Scan のデフォルト値の出典</strong>: <code>min_ratio_to_activate=1.2</code> 等の値は Google がモデルと共に配布した設定ではなく（preprocessor_config.json では全て null）、HF transformers の <code>processing_gemma3.py</code> 内の <code>Gemma3ProcessorKwargs._defaults</code> にハードコードされたフォールバック値。</p>
</li>
</ol>
<hr>
<h2 id="主要ファイル参照"><a class="header" href="#主要ファイル参照">主要ファイル参照</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>ファイル</th><th>主要クラス/関数</th></tr>
</thead>
<tbody>
<tr><td>vllm/…/gemma3_mm.py</td><td>Gemma3ForConditionalGeneration, Gemma3MultiModalProjector, Gemma3ProcessingInfo</td></tr>
<tr><td>vllm/…/siglip.py</td><td>SiglipVisionModel, SiglipVisionEmbeddings, SiglipEncoder</td></tr>
<tr><td>vllm/…/utils.py</td><td>_merge_multimodal_embeddings()</td></tr>
<tr><td>HF transformers/…/processing_gemma3.py</td><td>Gemma3Processor, Gemma3ProcessorKwargs (デフォルト値定義)</td></tr>
<tr><td>HF transformers/…/image_processing_gemma3.py</td><td>Gemma3ImageProcessor (Pan-and-Scan 実装)</td></tr>
</tbody>
</table>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../investigations/gemma3-vision-caches.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../glossary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../investigations/gemma3-vision-caches.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../glossary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid-eefea253.min.js"></script>
        <script src="../mermaid-init-ccf746f1.js"></script>



    </div>
    </body>
</html>
